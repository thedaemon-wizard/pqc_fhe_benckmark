{{/*
PQC-FHE Kubernetes HorizontalPodAutoscaler Template
=====================================================
Automatically scales API pods based on resource utilization.

Scaling Strategy:
- CPU-based scaling for general load
- Memory-based scaling for FHE operations (memory-intensive)
- Custom metrics for queue depth (if available)

Reference:
- Kubernetes HPA documentation
- Best practices for scaling cryptographic workloads
*/}}

{{- if .Values.api.autoscaling.enabled }}
apiVersion: {{ include "pqc-fhe.hpa.apiVersion" . }}
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "pqc-fhe.fullname" . }}-api
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pqc-fhe.api.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "pqc-fhe.fullname" . }}-api
  
  minReplicas: {{ .Values.api.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.api.autoscaling.maxReplicas }}
  
  metrics:
    # CPU utilization metric
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.api.autoscaling.targetCPUUtilizationPercentage | default 70 }}
    
    # Memory utilization metric (important for FHE operations)
    {{- if .Values.api.autoscaling.targetMemoryUtilizationPercentage }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.api.autoscaling.targetMemoryUtilizationPercentage }}
    {{- end }}
    
    # Custom metrics (if Prometheus adapter is configured)
    {{- if .Values.api.autoscaling.customMetrics }}
    {{- range .Values.api.autoscaling.customMetrics }}
    - type: Pods
      pods:
        metric:
          name: {{ .name }}
        target:
          type: AverageValue
          averageValue: {{ .targetAverageValue }}
    {{- end }}
    {{- end }}
    
    # External metrics (e.g., queue depth from Redis)
    {{- if .Values.api.autoscaling.externalMetrics }}
    {{- range .Values.api.autoscaling.externalMetrics }}
    - type: External
      external:
        metric:
          name: {{ .name }}
          {{- if .selector }}
          selector:
            {{- toYaml .selector | nindent 12 }}
          {{- end }}
        target:
          type: {{ .targetType | default "Value" }}
          {{- if eq .targetType "AverageValue" }}
          averageValue: {{ .targetValue }}
          {{- else }}
          value: {{ .targetValue }}
          {{- end }}
    {{- end }}
    {{- end }}
  
  behavior:
    scaleDown:
      # Stabilization window to prevent flapping
      stabilizationWindowSeconds: {{ .Values.api.autoscaling.scaleDown.stabilizationWindowSeconds | default 300 }}
      policies:
        # Scale down at most 1 pod per minute
        - type: Pods
          value: {{ .Values.api.autoscaling.scaleDown.podsPerMinute | default 1 }}
          periodSeconds: 60
        # Or scale down at most 10% per minute
        - type: Percent
          value: {{ .Values.api.autoscaling.scaleDown.percentPerMinute | default 10 }}
          periodSeconds: 60
      selectPolicy: {{ .Values.api.autoscaling.scaleDown.selectPolicy | default "Min" }}
    
    scaleUp:
      # Faster scale up for handling traffic spikes
      stabilizationWindowSeconds: {{ .Values.api.autoscaling.scaleUp.stabilizationWindowSeconds | default 0 }}
      policies:
        # Scale up at most 4 pods per minute
        - type: Pods
          value: {{ .Values.api.autoscaling.scaleUp.podsPerMinute | default 4 }}
          periodSeconds: 60
        # Or scale up at most 100% per minute
        - type: Percent
          value: {{ .Values.api.autoscaling.scaleUp.percentPerMinute | default 100 }}
          periodSeconds: 60
      selectPolicy: {{ .Values.api.autoscaling.scaleUp.selectPolicy | default "Max" }}
{{- end }}

{{- if and .Values.gpuWorker.enabled .Values.gpuWorker.autoscaling.enabled }}
---
# GPU Worker HPA (if GPU autoscaling is enabled)
# Note: GPU scaling is typically more conservative due to resource costs
apiVersion: {{ include "pqc-fhe.hpa.apiVersion" . }}
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "pqc-fhe.fullname" . }}-gpu-worker
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pqc-fhe.gpuWorker.labels" . | nindent 4 }}
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "pqc-fhe.fullname" . }}-gpu-worker
  
  minReplicas: {{ .Values.gpuWorker.autoscaling.minReplicas | default 1 }}
  maxReplicas: {{ .Values.gpuWorker.autoscaling.maxReplicas | default 4 }}
  
  metrics:
    # CPU utilization (for non-GPU work)
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.gpuWorker.autoscaling.targetCPUUtilizationPercentage | default 80 }}
    
    # Memory utilization
    {{- if .Values.gpuWorker.autoscaling.targetMemoryUtilizationPercentage }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.gpuWorker.autoscaling.targetMemoryUtilizationPercentage }}
    {{- end }}
    
    # GPU utilization metric (requires DCGM exporter or similar)
    {{- if .Values.gpuWorker.autoscaling.gpuMetrics.enabled }}
    - type: External
      external:
        metric:
          name: {{ .Values.gpuWorker.autoscaling.gpuMetrics.utilizationMetric | default "DCGM_FI_DEV_GPU_UTIL" }}
          selector:
            matchLabels:
              app.kubernetes.io/instance: {{ .Release.Name }}
              app.kubernetes.io/component: gpu-worker
        target:
          type: AverageValue
          averageValue: {{ .Values.gpuWorker.autoscaling.gpuMetrics.targetUtilization | default "70" }}
    {{- end }}
  
  behavior:
    scaleDown:
      # Very conservative scale down for GPU workers (expensive resources)
      stabilizationWindowSeconds: {{ .Values.gpuWorker.autoscaling.scaleDown.stabilizationWindowSeconds | default 600 }}
      policies:
        - type: Pods
          value: 1
          periodSeconds: 300
      selectPolicy: Min
    
    scaleUp:
      # Moderate scale up
      stabilizationWindowSeconds: {{ .Values.gpuWorker.autoscaling.scaleUp.stabilizationWindowSeconds | default 60 }}
      policies:
        - type: Pods
          value: 2
          periodSeconds: 60
      selectPolicy: Max
{{- end }}
