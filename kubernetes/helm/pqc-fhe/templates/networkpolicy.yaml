{{/*
PQC-FHE Kubernetes NetworkPolicy Template
==========================================
Implements network segmentation and access control.

Security Model:
- Default deny all ingress/egress
- Explicit allow rules for required communication
- Separation between API, GPU workers, and storage

Reference:
- Kubernetes NetworkPolicy documentation
- NIST SP 800-204: Security Strategies for Microservices
- Zero Trust Architecture principles
*/}}

{{- if .Values.networkPolicy.enabled }}
---
# Default deny all ingress and egress
apiVersion: {{ include "pqc-fhe.networkPolicy.apiVersion" . }}
kind: NetworkPolicy
metadata:
  name: {{ include "pqc-fhe.fullname" . }}-default-deny
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pqc-fhe.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "pqc-fhe.selectorLabels" . | nindent 6 }}
  policyTypes:
    - Ingress
    - Egress

---
# API Service Network Policy
apiVersion: {{ include "pqc-fhe.networkPolicy.apiVersion" . }}
kind: NetworkPolicy
metadata:
  name: {{ include "pqc-fhe.fullname" . }}-api
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pqc-fhe.api.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "pqc-fhe.api.selectorLabels" . | nindent 6 }}
  
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    # Allow ingress from ingress controller
    - from:
        {{- if .Values.networkPolicy.ingressController.namespaceSelector }}
        - namespaceSelector:
            matchLabels:
              {{- toYaml .Values.networkPolicy.ingressController.namespaceSelector | nindent 14 }}
          {{- if .Values.networkPolicy.ingressController.podSelector }}
          podSelector:
            matchLabels:
              {{- toYaml .Values.networkPolicy.ingressController.podSelector | nindent 14 }}
          {{- end }}
        {{- else }}
        # Default: allow from ingress-nginx namespace
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
        {{- end }}
      ports:
        - protocol: TCP
          port: {{ .Values.api.containerPort }}
    
    # Allow internal traffic from same namespace
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: {{ .Values.api.containerPort }}
    
    # Allow metrics scraping from Prometheus
    {{- if .Values.api.metrics.enabled }}
    - from:
        {{- if .Values.networkPolicy.prometheus.namespaceSelector }}
        - namespaceSelector:
            matchLabels:
              {{- toYaml .Values.networkPolicy.prometheus.namespaceSelector | nindent 14 }}
        {{- else }}
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
        {{- end }}
      ports:
        - protocol: TCP
          port: {{ .Values.api.metrics.port | default 9090 }}
    {{- end }}
    
    # Allow health checks from kubelet
    - from:
        - ipBlock:
            cidr: {{ .Values.networkPolicy.kubeletCIDR | default "0.0.0.0/0" }}
      ports:
        - protocol: TCP
          port: {{ .Values.api.containerPort }}
  
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    
    # Allow connection to Redis
    {{- if .Values.redis.enabled }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
    {{- end }}
    
    # Allow connection to GPU workers
    {{- if .Values.gpuWorker.enabled }}
    - to:
        - podSelector:
            matchLabels:
              {{- include "pqc-fhe.gpuWorker.selectorLabels" . | nindent 14 }}
      ports:
        - protocol: TCP
          port: 50051
    {{- end }}
    
    # Allow external HTTPS (for external APIs if needed)
    {{- if .Values.networkPolicy.allowExternalHTTPS }}
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443
    {{- end }}

{{- if .Values.gpuWorker.enabled }}
---
# GPU Worker Network Policy
apiVersion: {{ include "pqc-fhe.networkPolicy.apiVersion" . }}
kind: NetworkPolicy
metadata:
  name: {{ include "pqc-fhe.fullname" . }}-gpu-worker
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pqc-fhe.gpuWorker.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "pqc-fhe.gpuWorker.selectorLabels" . | nindent 6 }}
  
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    # Only allow ingress from API pods
    - from:
        - podSelector:
            matchLabels:
              {{- include "pqc-fhe.api.selectorLabels" . | nindent 14 }}
      ports:
        - protocol: TCP
          port: 50051
        - protocol: TCP
          port: 8081  # Health check
    
    # Allow metrics scraping
    {{- if .Values.gpuWorker.metrics.enabled }}
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: monitoring
      ports:
        - protocol: TCP
          port: {{ .Values.gpuWorker.metrics.port | default 9090 }}
    {{- end }}
  
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    
    # Allow connection to Redis (for caching)
    {{- if .Values.redis.enabled }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
    {{- end }}
{{- end }}

{{- if .Values.redis.enabled }}
---
# Redis Network Policy
apiVersion: {{ include "pqc-fhe.networkPolicy.apiVersion" . }}
kind: NetworkPolicy
metadata:
  name: {{ include "pqc-fhe.fullname" . }}-redis
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pqc-fhe.labels" . | nindent 4 }}
    app.kubernetes.io/component: redis
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: redis
  
  policyTypes:
    - Ingress
    - Egress
  
  ingress:
    # Only allow ingress from API and GPU worker pods
    - from:
        - podSelector:
            matchLabels:
              {{- include "pqc-fhe.api.selectorLabels" . | nindent 14 }}
        {{- if .Values.gpuWorker.enabled }}
        - podSelector:
            matchLabels:
              {{- include "pqc-fhe.gpuWorker.selectorLabels" . | nindent 14 }}
        {{- end }}
      ports:
        - protocol: TCP
          port: 6379
  
  egress:
    # Allow DNS resolution
    - to:
        - namespaceSelector: {}
          podSelector:
            matchLabels:
              k8s-app: kube-dns
      ports:
        - protocol: UDP
          port: 53
    
    # Allow replication between Redis pods (if sentinel/cluster mode)
    {{- if ne .Values.redis.architecture "standalone" }}
    - to:
        - podSelector:
            matchLabels:
              app.kubernetes.io/name: redis
      ports:
        - protocol: TCP
          port: 6379
        - protocol: TCP
          port: 26379  # Sentinel
    {{- end }}
{{- end }}
{{- end }}
