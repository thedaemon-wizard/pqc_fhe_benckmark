{{/*
PQC-FHE Kubernetes ConfigMap Template
=======================================
Stores non-sensitive configuration for the PQC-FHE system.

Configuration includes:
- PQC algorithm parameters (NIST FIPS 203/204/205)
- FHE scheme parameters (CKKS)
- Application settings
- Logging configuration

Reference:
- NIST FIPS 203: ML-KEM (Module-Lattice-Based Key-Encapsulation Mechanism)
- NIST FIPS 204: ML-DSA (Module-Lattice-Based Digital Signature Algorithm)
- DESILO FHE Documentation: CKKS scheme parameters
*/}}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pqc-fhe.fullname" . }}-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pqc-fhe.labels" . | nindent 4 }}
data:
  # ========================================
  # PQC Configuration (NIST FIPS 203/204)
  # ========================================
  PQC_KEM_ALGORITHM: {{ .Values.crypto.pqc.kemAlgorithm | quote }}
  PQC_KEM_SECURITY_LEVEL: {{ .Values.crypto.pqc.kemSecurityLevel | quote }}
  PQC_SIGNATURE_ALGORITHM: {{ .Values.crypto.pqc.signatureAlgorithm | quote }}
  PQC_SIGNATURE_SECURITY_LEVEL: {{ .Values.crypto.pqc.signatureSecurityLevel | quote }}
  
  # ML-KEM Parameters (FIPS 203)
  # Security Level 1 (ML-KEM-512): 128-bit security
  # Security Level 3 (ML-KEM-768): 192-bit security
  # Security Level 5 (ML-KEM-1024): 256-bit security
  ML_KEM_VARIANT: {{ .Values.crypto.pqc.kemAlgorithm | quote }}
  
  # ML-DSA Parameters (FIPS 204)
  # Security Level 2 (ML-DSA-44): 128-bit security
  # Security Level 3 (ML-DSA-65): 192-bit security
  # Security Level 5 (ML-DSA-87): 256-bit security
  ML_DSA_VARIANT: {{ .Values.crypto.pqc.signatureAlgorithm | quote }}
  
  # ========================================
  # FHE Configuration (CKKS Scheme)
  # ========================================
  # Reference: DESILO FHE Library documentation
  # https://fhe.desilo.dev/latest/
  FHE_SCHEME: "CKKS"
  FHE_POLY_MODULUS_DEGREE: {{ .Values.crypto.fhe.polyModulusDegree | quote }}
  FHE_COEFF_MOD_BIT_SIZES: {{ .Values.crypto.fhe.coeffModBitSizes | toJson | quote }}
  FHE_SCALE_BITS: {{ .Values.crypto.fhe.scaleBits | quote }}
  FHE_SECURITY_LEVEL: {{ .Values.crypto.fhe.securityLevel | quote }}
  
  # Bootstrap configuration (for deep computations)
  FHE_BOOTSTRAP_ENABLED: {{ .Values.crypto.fhe.bootstrapEnabled | default "true" | quote }}
  FHE_BOOTSTRAP_THRESHOLD: {{ .Values.crypto.fhe.bootstrapThreshold | default "8" | quote }}
  
  # ========================================
  # Application Configuration
  # ========================================
  APP_ENV: {{ .Values.app.environment | default "production" | quote }}
  APP_LOG_LEVEL: {{ .Values.app.logLevel | default "INFO" | quote }}
  APP_LOG_FORMAT: {{ .Values.app.logFormat | default "json" | quote }}
  
  # API Configuration
  API_HOST: "0.0.0.0"
  API_PORT: {{ .Values.api.containerPort | quote }}
  API_WORKERS: {{ .Values.api.workers | default "4" | quote }}
  API_TIMEOUT: {{ .Values.api.timeout | default "300" | quote }}
  
  # Rate limiting
  RATE_LIMIT_ENABLED: {{ .Values.api.rateLimit.enabled | default "true" | quote }}
  RATE_LIMIT_REQUESTS_PER_MINUTE: {{ .Values.api.rateLimit.requestsPerMinute | default "60" | quote }}
  
  # ========================================
  # Cache Configuration
  # ========================================
  {{- if .Values.redis.enabled }}
  CACHE_TYPE: "redis"
  CACHE_REDIS_HOST: "{{ include "pqc-fhe.fullname" . }}-redis-master"
  CACHE_REDIS_PORT: "6379"
  CACHE_REDIS_DB: "0"
  CACHE_TTL_SECONDS: {{ .Values.cache.ttlSeconds | default "3600" | quote }}
  {{- else }}
  CACHE_TYPE: "memory"
  CACHE_MAX_SIZE_MB: {{ .Values.cache.maxSizeMB | default "512" | quote }}
  {{- end }}
  
  # ========================================
  # Security Configuration
  # ========================================
  # Key rotation settings
  KEY_ROTATION_ENABLED: {{ .Values.security.keyRotation.enabled | default "true" | quote }}
  KEY_ROTATION_INTERVAL_HOURS: {{ .Values.security.keyRotation.intervalHours | default "168" | quote }}
  
  # Audit logging
  AUDIT_LOG_ENABLED: {{ .Values.security.audit.enabled | default "true" | quote }}
  AUDIT_LOG_RETENTION_DAYS: {{ .Values.security.audit.retentionDays | default "90" | quote }}
  
  # ========================================
  # GPU Worker Configuration
  # ========================================
  {{- if .Values.gpuWorker.enabled }}
  GPU_WORKER_ENABLED: "true"
  GPU_WORKER_HOST: "{{ include "pqc-fhe.fullname" . }}-gpu-worker"
  GPU_WORKER_PORT: "50051"
  GPU_MEMORY_FRACTION: {{ .Values.gpuWorker.memoryFraction | default "0.9" | quote }}
  CUDA_VISIBLE_DEVICES: {{ .Values.gpuWorker.cudaVisibleDevices | default "0" | quote }}
  {{- else }}
  GPU_WORKER_ENABLED: "false"
  {{- end }}
  
  # ========================================
  # Metrics Configuration
  # ========================================
  METRICS_ENABLED: {{ .Values.api.metrics.enabled | default "true" | quote }}
  METRICS_PORT: {{ .Values.api.metrics.port | default "9090" | quote }}
  METRICS_PATH: {{ .Values.api.metrics.path | default "/metrics" | quote }}
  
  # ========================================
  # JSON Configuration Files
  # ========================================
  pqc-config.json: |
    {{- include "pqc-fhe.pqcConfig" . | nindent 4 }}
  
  fhe-config.json: |
    {{- include "pqc-fhe.fheConfig" . | nindent 4 }}
  
  # Logging configuration
  logging-config.json: |
    {
      "version": 1,
      "disable_existing_loggers": false,
      "formatters": {
        "json": {
          "class": "pythonjsonlogger.jsonlogger.JsonFormatter",
          "format": "%(asctime)s %(levelname)s %(name)s %(message)s"
        },
        "standard": {
          "format": "%(asctime)s [%(levelname)s] %(name)s: %(message)s"
        }
      },
      "handlers": {
        "console": {
          "class": "logging.StreamHandler",
          "level": "{{ .Values.app.logLevel | default "INFO" }}",
          "formatter": "{{ .Values.app.logFormat | default "json" }}",
          "stream": "ext://sys.stdout"
        }
      },
      "root": {
        "level": "{{ .Values.app.logLevel | default "INFO" }}",
        "handlers": ["console"]
      },
      "loggers": {
        "pqc_fhe": {
          "level": "{{ .Values.app.logLevel | default "INFO" }}",
          "handlers": ["console"],
          "propagate": false
        },
        "uvicorn": {
          "level": "INFO",
          "handlers": ["console"],
          "propagate": false
        }
      }
    }

---
# Algorithm reference documentation (for operators)
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "pqc-fhe.fullname" . }}-algorithm-reference
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "pqc-fhe.labels" . | nindent 4 }}
data:
  README.md: |
    # PQC-FHE Algorithm Reference
    
    ## Post-Quantum Cryptography (PQC)
    
    ### ML-KEM (FIPS 203) - Key Encapsulation Mechanism
    - **ML-KEM-512**: 128-bit security, smallest key sizes
    - **ML-KEM-768**: 192-bit security (recommended)
    - **ML-KEM-1024**: 256-bit security, highest security
    
    ### ML-DSA (FIPS 204) - Digital Signatures
    - **ML-DSA-44**: Category 2, ~128-bit security
    - **ML-DSA-65**: Category 3, ~192-bit security (recommended)
    - **ML-DSA-87**: Category 5, ~256-bit security
    
    ## Fully Homomorphic Encryption (FHE)
    
    ### CKKS Scheme Parameters
    - **poly_modulus_degree**: Ring dimension (8192, 16384, 32768)
    - **coeff_mod_bit_sizes**: Coefficient modulus chain
    - **scale_bits**: Encoding precision
    - **security_level**: 128 or 256 bits
    
    ### Bootstrap Configuration
    - Required for deep computations (many multiplications)
    - Threshold: Number of levels before bootstrap
    - Stage count: Bootstrap quality vs performance tradeoff
    
    ## Security Levels Mapping
    
    | NIST Level | Classical Security | PQC-KEM      | PQC-Sign    |
    |------------|-------------------|--------------|-------------|
    | 1          | 128-bit           | ML-KEM-512   | -           |
    | 2          | -                 | -            | ML-DSA-44   |
    | 3          | 192-bit           | ML-KEM-768   | ML-DSA-65   |
    | 5          | 256-bit           | ML-KEM-1024  | ML-DSA-87   |
    
    ## References
    - NIST FIPS 203: https://csrc.nist.gov/pubs/fips/203/final
    - NIST FIPS 204: https://csrc.nist.gov/pubs/fips/204/final
    - DESILO FHE: https://fhe.desilo.dev/latest/
